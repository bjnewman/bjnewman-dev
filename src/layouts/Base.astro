---
import { ClientRouter } from 'astro:transitions';
import SecretFeatures from '../SecretFeatures';
import ThemeToggle from '../components/ThemeToggle';
import { PageCollectible } from '../components/ScavengerHunt';
import '../styles/theme.css';
import '../styles/components.css';
import '../styles/microinteractions.css';
import '../styles/secret-menu.css';
import '../styles/scavenger-hunt.css';
import '../styles/view-transitions.css';

interface Props {
  title?: string;
  description?: string;
}

const {
  title,
  description = "Software engineer and technology enthusiast. Building modern web applications with React, TypeScript, and Astro."
} = Astro.props;

const pageTitle = title ? `${title} — Ben Newman` : 'Ben Newman';
const canonicalURL = new URL(Astro.url.pathname, Astro.site);
const currentPath = Astro.url.pathname;
---

<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">

    <!-- Primary Meta Tags -->
    <title>{pageTitle}</title>
    <meta name="title" content={pageTitle}>
    <meta name="description" content={description}>
    <meta name="author" content="Ben Newman">
    <link rel="canonical" href={canonicalURL}>

    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:url" content={canonicalURL}>
    <meta property="og:title" content={pageTitle}>
    <meta property="og:description" content={description}>
    <meta property="og:site_name" content="Ben Newman">
    <meta property="og:image" content={`${Astro.site}og-image.png`}>

    <!-- Fonts with optimized loading -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Nunito:wght@400;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">

    <!-- RSS Feed -->
    <link rel="alternate" type="application/rss+xml" title="Ben Newman's Blog" href="/rss.xml">

    <!-- Client Router for View Transitions -->
    <ClientRouter />

    <!-- Prevent FOUC by applying saved theme and nav style before render -->
    <!-- Storage keys must match src/constants/storage.ts -->
    <script is:inline>
      (function() {
        // Theme handling (key: STORAGE_KEYS.THEME)
        const savedThemeId = localStorage.getItem('bjnewman-theme');
        if (savedThemeId) {
          const themes = {
            'professional': { primary: '#6366f1', primaryLight: '#818cf8', primaryDark: '#4f46e5', accent: '#ec4899', accentLight: '#f472b6', textPrimary: '#1e293b', textSecondary: '#64748b', textMuted: '#94a3b8', bgGradient: 'linear-gradient(135deg, #f8fafc 0%, #e0e7ff 50%, #fce7f3 100%)', bgPrimary: '#ffffff', bgSecondary: '#f8fafc', bgTertiary: '#f1f5f9' },
            'sunset': { primary: '#f97316', primaryLight: '#fb923c', primaryDark: '#ea580c', accent: '#f59e0b', accentLight: '#fbbf24', textPrimary: '#1e293b', textSecondary: '#64748b', textMuted: '#94a3b8', bgGradient: 'linear-gradient(135deg, #fef3c7 0%, #fed7aa 50%, #fecaca 100%)', bgPrimary: '#ffffff', bgSecondary: '#f8fafc', bgTertiary: '#f1f5f9' },
            'ocean': { primary: '#0ea5e9', primaryLight: '#38bdf8', primaryDark: '#0284c7', accent: '#06b6d4', accentLight: '#22d3ee', textPrimary: '#1e293b', textSecondary: '#64748b', textMuted: '#94a3b8', bgGradient: 'linear-gradient(135deg, #e0f2fe 0%, #bae6fd 50%, #ddd6fe 100%)', bgPrimary: '#ffffff', bgSecondary: '#f8fafc', bgTertiary: '#f1f5f9' },
            'forest': { primary: '#10b981', primaryLight: '#34d399', primaryDark: '#059669', accent: '#14b8a6', accentLight: '#2dd4bf', textPrimary: '#1e293b', textSecondary: '#64748b', textMuted: '#94a3b8', bgGradient: 'linear-gradient(135deg, #d1fae5 0%, #a7f3d0 50%, #bfdbfe 100%)', bgPrimary: '#ffffff', bgSecondary: '#f8fafc', bgTertiary: '#f1f5f9' },
            'dark': { primary: '#818cf8', primaryLight: '#a5b4fc', primaryDark: '#6366f1', accent: '#f472b6', accentLight: '#f9a8d4', textPrimary: '#f1f5f9', textSecondary: '#cbd5e1', textMuted: '#94a3b8', bgGradient: 'linear-gradient(135deg, #0f172a 0%, #1e1b4b 50%, #312e81 100%)', bgPrimary: '#1e293b', bgSecondary: '#334155', bgTertiary: '#475569' },
            'pastel': { primary: '#E6D1FF', primaryLight: '#F5E6FF', primaryDark: '#D1B3FF', accent: '#FFD1DC', accentLight: '#FFE6ED', textPrimary: '#4A4A4A', textSecondary: '#757575', textMuted: '#999999', bgGradient: 'linear-gradient(135deg, #BFDFFF 0%, #FFD1DC 100%)', bgPrimary: '#ffffff', bgSecondary: '#f8fafc', bgTertiary: '#f1f5f9' },
            'brutalist': { primary: '#000000', primaryLight: '#333333', primaryDark: '#000000', accent: '#ff0000', accentLight: '#ff3333', textPrimary: '#000000', textSecondary: '#333333', textMuted: '#666666', bgGradient: 'linear-gradient(135deg, #ffffff 0%, #f5f5f5 100%)', bgPrimary: '#ffffff', bgSecondary: '#f5f5f5', bgTertiary: '#eeeeee', className: 'theme-brutalist' },
            '90s': { primary: '#ff00ff', primaryLight: '#ff66ff', primaryDark: '#cc00cc', accent: '#00ffff', accentLight: '#66ffff', textPrimary: '#0000ff', textSecondary: '#ff00ff', textMuted: '#00ff00', bgGradient: 'linear-gradient(135deg, #ffff00 0%, #ff00ff 50%, #00ffff 100%)', bgPrimary: '#ffffff', bgSecondary: '#ffffcc', bgTertiary: '#ffccff', className: 'theme-90s' },
            'vaporwave': { primary: '#ff71ce', primaryLight: '#ff8fd8', primaryDark: '#e653b3', accent: '#01cdfe', accentLight: '#34d9ff', textPrimary: '#ffffff', textSecondary: '#e0e0e0', textMuted: '#b0b0b0', bgGradient: 'linear-gradient(180deg, #2d1b69 0%, #5b2a86 50%, #ff71ce 100%)', bgPrimary: '#2d1b69', bgSecondary: '#3d2b79', bgTertiary: '#4d3b89', className: 'theme-vaporwave' },
            'minimalist': { primary: '#1a1a1a', primaryLight: '#333333', primaryDark: '#000000', accent: '#666666', accentLight: '#999999', textPrimary: '#333333', textSecondary: '#666666', textMuted: '#999999', bgGradient: 'linear-gradient(135deg, #fafafa 0%, #f5f5f5 100%)', bgPrimary: '#ffffff', bgSecondary: '#fafafa', bgTertiary: '#f5f5f5', className: 'theme-minimalist' },
            'terminal': { primary: '#00ff00', primaryLight: '#66ff66', primaryDark: '#00aa00', accent: '#00ff00', accentLight: '#66ff66', textPrimary: '#00ff00', textSecondary: '#00aa00', textMuted: '#008800', bgGradient: 'linear-gradient(135deg, #000000 0%, #001100 100%)', bgPrimary: '#000000', bgSecondary: '#001100', bgTertiary: '#002200', className: 'theme-terminal' },
            'legal-pad': { primary: '#6366f1', primaryLight: '#818cf8', primaryDark: '#4f46e5', accent: '#ec4899', accentLight: '#f472b6', textPrimary: '#1e293b', textSecondary: '#64748b', textMuted: '#94a3b8', bgGradient: 'none', bgPrimary: '#ffffff', bgSecondary: '#f8fafc', bgTertiary: '#f1f5f9', className: 'theme-legal-pad' }
          };
          const theme = themes[savedThemeId];
          if (theme) {
            const root = document.documentElement;
            root.style.setProperty('--primary', theme.primary);
            root.style.setProperty('--primary-light', theme.primaryLight);
            root.style.setProperty('--primary-dark', theme.primaryDark);
            root.style.setProperty('--accent', theme.accent);
            root.style.setProperty('--accent-light', theme.accentLight);
            root.style.setProperty('--text-primary', theme.textPrimary);
            root.style.setProperty('--text-secondary', theme.textSecondary);
            root.style.setProperty('--text-muted', theme.textMuted);
            root.style.setProperty('--bg-primary', theme.bgPrimary);
            root.style.setProperty('--bg-secondary', theme.bgSecondary);
            root.style.setProperty('--bg-tertiary', theme.bgTertiary);
            root.style.setProperty('--bg-gradient', theme.bgGradient);
            // Apply theme className if present
            if (theme.className) {
              document.body.classList.add(theme.className);
            }
          }
        }

        // Nav style handling - apply once nav element exists
        const savedNavStyle = localStorage.getItem('bjnewman-nav-style');
        if (savedNavStyle) {
          const navStyles = ['nav-filing-tabs', 'nav-index-cards', 'nav-cli-prompt', 'nav-neon-float', 'nav-win95', 'nav-minimal'];
          const applyNavStyle = () => {
            const nav = document.querySelector('.site-nav');
            if (nav) {
              navStyles.forEach(cls => nav.classList.remove(cls));
              nav.classList.add('nav-' + savedNavStyle);
            }
          };
          // Try immediately (for cached pages), or wait for DOM
          if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', applyNavStyle);
          } else {
            applyNavStyle();
          }
        }
      })();
    </script>
  </head>
  <body class="theme-legal-pad">
    <!-- Skip to main content link for keyboard navigation -->
    <a href="#main-content" class="skip-link">Skip to main content</a>

    <!-- Header - visible for non-legal-pad themes, hidden for legal-pad -->
    <header role="banner" class="site-header">
      <nav role="navigation" aria-label="Main navigation" class="site-nav nav-filing-tabs">
        <a href="/" class={`nav-link ${currentPath === '/' ? 'active' : ''}`}>Home</a>
        <a href="/about" class={`nav-link ${currentPath.startsWith('/about') ? 'active' : ''}`}>About</a>
        <a href="/projects" class={`nav-link ${currentPath.startsWith('/projects') ? 'active' : ''}`}>Projects</a>
        <a href="/resume" class={`nav-link ${currentPath.startsWith('/resume') ? 'active' : ''}`}>Resume</a>
        <a href="/blog" class={`nav-link ${currentPath.startsWith('/blog') ? 'active' : ''}`}>Blog</a>
        <a href="/dashboard" class={`nav-link ${currentPath.startsWith('/dashboard') ? 'active' : ''}`}>Dashboard</a>
      </nav>
      <ThemeToggle client:load />
    </header>

    <!-- Manila folder wrapper with integrated folder tabs -->
    <div class="manila-folder-wrapper">
      <!-- Folder tabs - navigation attached to the folder -->
      <nav role="navigation" aria-label="Main navigation" class="folder-tabs">
        <a href="/" class="folder-tabs__home" aria-label="Back to desk">
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
            <rect x="2" y="4" width="20" height="16" rx="2"/>
            <path d="M2 8h20"/>
            <path d="m9 4 3 4 3-4"/>
          </svg>
        </a>
        <a href="/about" class={`folder-tabs__tab ${currentPath.startsWith('/about') ? 'folder-tabs__tab--active' : ''}`}>About</a>
        <a href="/projects" class={`folder-tabs__tab ${currentPath.startsWith('/projects') ? 'folder-tabs__tab--active' : ''}`}>Projects</a>
        <a href="/resume" class={`folder-tabs__tab ${currentPath.startsWith('/resume') ? 'folder-tabs__tab--active' : ''}`}>Resume</a>
        <a href="/blog" class={`folder-tabs__tab ${currentPath.startsWith('/blog') ? 'folder-tabs__tab--active' : ''}`}>Blog</a>
        <a href="/dashboard" class={`folder-tabs__tab ${currentPath.startsWith('/dashboard') ? 'folder-tabs__tab--active' : ''}`}>Dashboard</a>
        <ThemeToggle client:load />
      </nav>
      <main id="main-content" role="main" class="page-content">
        <slot />
      </main>

      <footer role="contentinfo" class="site-footer">
        <div class="social-links">
          <a href="https://github.com/bjnewman" target="_blank" rel="noopener noreferrer" aria-label="GitHub profile">GitHub</a>
          <a href="https://gitlab.com/bjnewman" target="_blank" rel="noopener noreferrer" aria-label="GitLab profile">GitLab</a>
          <a href="https://linkedin.com/in/bjnewman" target="_blank" rel="noopener noreferrer" aria-label="LinkedIn profile">LinkedIn</a>
          <a href="/rss.xml" aria-label="RSS feed">RSS</a>
          <a href="/privacy/">Privacy</a>
        </div>
        <p>© 2026 Ben Newman <PageCollectible id="magic_crystal" client:visible /></p>
        <p class="disclaimer">Not legal advice. I'm a developer now. Ask a real lawyer.</p>
      </footer>
    </div>
    <SecretFeatures client:idle />

    <!-- View transition logic for landing ↔ content (inline to run on every navigation) -->
    <script is:inline>
      // Only set up listeners once
      if (!window.__viewTransitionListenersSet) {
        window.__viewTransitionListenersSet = true;

        // Debug mode - set to true to see transition logs
        const DEBUG_TRANSITIONS = false;
        function logTransition(event, details) {
          if (DEBUG_TRANSITIONS) {
            console.log('[ViewTransition]', event, details);
          }
        }

        // Log bounding box for debugging
        function logBoundingBox(label, element) {
          if (DEBUG_TRANSITIONS && element) {
            const rect = element.getBoundingClientRect();
            const styles = getComputedStyle(element);
            console.log('[ViewTransition] ' + label + ' bounding box:', {
              width: rect.width,
              height: rect.height,
              top: rect.top,
              left: rect.left,
              viewTransitionName: styles.viewTransitionName,
              display: styles.display,
              opacity: styles.opacity
            });
          }
        }

        // Track which folder was clicked
        let clickedFolderId = null;

        // Listen for clicks on folders to track which one was clicked
        document.addEventListener('click', function(e) {
          const folder = e.target.closest('[data-folder-id]');
          if (folder) {
            clickedFolderId = folder.getAttribute('data-folder-id');
            logTransition('click', { clickedFolderId });
          }
        }, true);

        // Map paths to folder IDs
        const pathToFolderId = {
          '/about': 'about',
          '/projects': 'projects',
          '/blog': 'blog',
          '/resume': 'resume',
          '/dashboard': 'dashboard',
        };

        function getFolderIdFromPath(path) {
          for (const prefix in pathToFolderId) {
            if (path.startsWith(prefix)) return pathToFolderId[prefix];
          }
          return null;
        }

        // Helper to disable child view-transition-names during folder morphing
        // (Elements can't have view-transition-name if an ancestor has one)
        function disableChildTransitionNames(doc) {
          const selectors = ['.folder-tabs', '.page-content', '.site-footer'];
          selectors.forEach(function(sel) {
            const el = doc.querySelector(sel);
            if (el) el.style.viewTransitionName = 'none';
          });
        }

        // Helper to restore child view-transition-names after transition
        function restoreChildTransitionNames() {
          const selectors = ['.folder-tabs', '.page-content', '.site-footer'];
          selectors.forEach(function(sel) {
            const el = document.querySelector(sel);
            if (el) el.style.viewTransitionName = '';
          });
        }

        // Before preparation: set up view-transition-names on CURRENT document
        // (astro:after-preparation has no attributes, so we use before-preparation)
        document.addEventListener('astro:before-preparation', function(event) {
          const fromPath = event.from.pathname;
          const toPath = event.to.pathname;
          const isFromLanding = fromPath === '/';
          const isToLanding = toPath === '/';
          const fromFolderId = getFolderIdFromPath(fromPath);

          logTransition('before-preparation', { fromPath, toPath, isFromLanding, isToLanding, fromFolderId, clickedFolderId });

          // Landing → Content: Set view-transition-name on the clicked folder
          // Using data attribute + CSS rule instead of inline style for more reliable capture
          if (isFromLanding && clickedFolderId) {
            const clickedFolder = document.querySelector('[data-folder-id="' + clickedFolderId + '"]');
            if (clickedFolder) {
              clickedFolder.setAttribute('data-vt-active', 'true');
              // Force style recalculation before view transition captures
              void clickedFolder.offsetHeight;
              logTransition('set-name-on-folder', { folderId: clickedFolderId, element: clickedFolder });
            }
          }

          // Content → Landing: Set view-transition-name on manila-folder-wrapper
          // Using data attribute + CSS rule instead of inline style for more reliable capture
          if (isToLanding && fromFolderId) {
            const currentWrapper = document.querySelector('.manila-folder-wrapper');
            if (currentWrapper) {
              // Force display: block (required for view transitions - display: contents has no box)
              currentWrapper.style.display = 'block';
              currentWrapper.setAttribute('data-vt-folder', fromFolderId);
              // Force style recalculation before view transition captures
              void currentWrapper.offsetHeight;
              // Disable child view-transition-names (can't nest them)
              disableChildTransitionNames(document);
              logTransition('set-name-on-wrapper', { folderId: fromFolderId, display: currentWrapper.style.display });
            }
          }
        });

        // Before DOM swap: add view-transition-name to new page's wrapper/folder
        document.addEventListener('astro:before-swap', function(event) {
          const fromPath = event.from.pathname;
          const toPath = event.to.pathname;
          const isFromLanding = fromPath === '/';
          const isToLanding = toPath === '/';
          const toFolderId = getFolderIdFromPath(toPath);
          const fromFolderId = getFolderIdFromPath(fromPath);

          logTransition('before-swap', { fromPath, toPath, isFromLanding, isToLanding, toFolderId, fromFolderId });

          // Landing → Content: Add folder ID to NEW page's wrapper
          // Using data attribute + CSS rule instead of inline style for more reliable capture
          if (isFromLanding && toFolderId) {
            const newWrapper = event.newDocument.querySelector('.manila-folder-wrapper');
            if (newWrapper) {
              // Force display: block for transition
              newWrapper.style.display = 'block';
              newWrapper.setAttribute('data-vt-folder', toFolderId);
              // Disable child view-transition-names on new page
              disableChildTransitionNames(event.newDocument);
              logTransition('set-name-on-new-wrapper', { folderId: toFolderId });
            } else {
              logTransition('ERROR: new wrapper not found');
            }
          }

          // Content → Landing: Add folder ID to the matching folder on landing page
          // Using data attribute + CSS rule instead of inline style for more reliable capture
          if (isToLanding && fromFolderId) {
            const targetFolder = event.newDocument.querySelector('[data-folder-id="' + fromFolderId + '"]');
            if (targetFolder) {
              targetFolder.setAttribute('data-vt-active', 'true');
              logTransition('set-name-on-target-folder', { folderId: fromFolderId });
            } else {
              logTransition('ERROR: target folder not found', { fromFolderId });
            }
          }
        });

        // After swap: clean up data attributes and inline styles
        document.addEventListener('astro:after-swap', function() {
          logTransition('after-swap', { cleaning: true });
          clickedFolderId = null;
          const wrapper = document.querySelector('.manila-folder-wrapper');
          if (wrapper) {
            wrapper.removeAttribute('data-vt-folder');
            wrapper.style.display = '';
          }
          const folders = document.querySelectorAll('[data-folder-id]');
          folders.forEach(function(f) {
            f.removeAttribute('data-vt-active');
          });
          // Restore child view-transition-names for content↔content transitions
          restoreChildTransitionNames();
        });
      }
    </script>
  </body>
</html>
