---
import Base from '../../layouts/Base.astro';
import { PageCollectible } from '../../components/ScavengerHunt';

interface MarkdownPost {
  url: string;
  frontmatter: {
    title: string;
    date: string;
  };
}

// Get all markdown files in blog directory using import.meta.glob
const postFiles = import.meta.glob('./*.md', { eager: true });
const posts = Object.values(postFiles).map((post) => {
  const mdPost = post as MarkdownPost;
  return {
    url: mdPost.url,
    frontmatter: mdPost.frontmatter,
  };
});

const sortedPosts = posts.sort((a, b) =>
  new Date(b.frontmatter.date).valueOf() - new Date(a.frontmatter.date).valueOf()
);

// Blogroll with RSS feeds for sorting by most recently updated
interface BlogrollEntry {
  name: string;
  url: string;
  rss?: string; // Optional RSS feed URL
}

const blogrollData: BlogrollEntry[] = [
  { name: 'Overreacted', url: 'https://overreacted.io', rss: 'https://overreacted.io/rss.xml' },
  { name: 'Lea Verou', url: 'https://lea.verou.me', rss: 'https://lea.verou.me/feed/' },
  { name: 'Josh Comeau', url: 'https://www.joshwcomeau.com', rss: 'https://www.joshwcomeau.com/rss.xml' },
  { name: 'Cassidy Williams', url: 'https://cassidoo.co', rss: 'https://cassidoo.co/rss.xml' },
  { name: 'Kent C. Dodds', url: 'https://kentcdodds.com/blog', rss: 'https://kentcdodds.com/blog/rss.xml' },
  { name: 'Maggie Appleton', url: 'https://maggieappleton.com', rss: 'https://maggieappleton.com/rss.xml' },
  { name: 'Addy Osmani', url: 'https://addyosmani.com', rss: 'https://addyosmani.com/feed.xml' },
  { name: "Addy Osmani's LLM Coding Workflow", url: 'https://medium.com/@addyosmani/my-llm-coding-workflow-going-into-2026-52fe1681325e' }, // Single article, no RSS
  { name: 'Angie Jones', url: 'https://angiejones.tech/blog/', rss: 'https://angiejones.tech/feed/' },
  { name: 'Taylor Poindexter', url: 'https://poindexter.dev', rss: 'http://green-pumpkin-nme8.squarespace.com/poindexter-blog?format=rss' },
  { name: 'Julia Evans', url: 'https://jvns.ca', rss: 'https://jvns.ca/atom.xml' },
  { name: 'Xe Iaso', url: 'https://xeiaso.net', rss: 'https://xeiaso.net/blog.rss' },
  { name: 'Lindsey Kopacz', url: 'https://a11ywithlindsey.com', rss: 'https://a11ywithlindsey.com/rss.xml' },
];

// Fetch RSS and extract latest post date
async function getLatestPostDate(rssUrl: string): Promise<Date | null> {
  try {
    const controller = new AbortController();
    const timeout = setTimeout(() => controller.abort(), 5000); // 5s timeout

    const response = await fetch(rssUrl, {
      signal: controller.signal,
      headers: { 'User-Agent': 'bjnewman.dev blogroll fetcher' }
    });
    clearTimeout(timeout);

    if (!response.ok) return null;

    const xml = await response.text();

    // Try to find pubDate or dc:date in first item
    const itemMatch = xml.match(/<item[^>]*>[\s\S]*?<\/item>/i) ||
                      xml.match(/<entry[^>]*>[\s\S]*?<\/entry>/i);
    if (!itemMatch) return null;

    const dateMatch = itemMatch[0].match(/<pubDate>([^<]+)<\/pubDate>/i) ||
                      itemMatch[0].match(/<dc:date>([^<]+)<\/dc:date>/i) ||
                      itemMatch[0].match(/<published>([^<]+)<\/published>/i) ||
                      itemMatch[0].match(/<updated>([^<]+)<\/updated>/i);

    if (!dateMatch) return null;

    const date = new Date(dateMatch[1].trim());
    return isNaN(date.getTime()) ? null : date;
  } catch {
    return null;
  }
}

// Fetch all RSS feeds in parallel and sort
const blogrollWithDates = await Promise.all(
  blogrollData.map(async (blog) => {
    const lastUpdated = blog.rss ? await getLatestPostDate(blog.rss) : null;
    return { ...blog, lastUpdated };
  })
);

// Sort: blogs with dates first (newest to oldest), then blogs without dates
const sortedBlogroll = blogrollWithDates.sort((a, b) => {
  if (a.lastUpdated && b.lastUpdated) {
    return b.lastUpdated.getTime() - a.lastUpdated.getTime();
  }
  if (a.lastUpdated) return -1; // a has date, b doesn't -> a first
  if (b.lastUpdated) return 1;  // b has date, a doesn't -> b first
  return 0; // Neither has date, keep original order
});
---

<Base title="Blog">
  <div class="blog-container">
    <div class="blog-main">
      <h1>Blog Posts</h1>

      {sortedPosts.length === 0 ? (
        <p>No blog posts yet. Check back soon!</p>
      ) : (
        <ul class="blog-list">
          {sortedPosts.map((post) => (
            <li>
              <article>
                <h2>
                  <a href={post.url}>{post.frontmatter.title}</a>
                </h2>
                <time datetime={post.frontmatter.date}>
                  {new Date(post.frontmatter.date).toLocaleDateString('en-US', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                  })}
                </time>
              </article>
            </li>
          ))}
        </ul>
      )}
    </div>

    <aside class="blogroll">
      <h3>Blogroll</h3>

      <ul class="blogroll-links">
        {sortedBlogroll.map((blog) => (
          <li>
            <a href={blog.url} target="_blank" rel="noopener noreferrer">{blog.name}</a>
          </li>
        ))}
      </ul>

      <div class="blogroll-footer">
        <a href="/rss.xml" class="rss-badge">
          <span class="rss-icon">ðŸ“¡</span>
          <span>RSS Feed</span>
        </a>
        <PageCollectible id="hidden_key" client:visible />
      </div>
    </aside>
  </div>
</Base>

<style>
/* Two-column layout */
.blog-container {
  display: grid;
  grid-template-columns: 1fr 320px;
  gap: 3rem;
  max-width: 1200px;
  margin: 0 auto;
}

@media (max-width: 768px) {
  .blog-container {
    grid-template-columns: 1fr;
  }
}

/* Blog posts */
.blog-main h1 {
  margin-bottom: 2rem;
}

.blog-list {
  list-style: none;
  padding: 0;
}

.blog-list li {
  margin: 2rem 0;
  padding-bottom: 2rem;
  border-bottom: 1px solid var(--bg-tertiary);
}

.blog-list li:last-child {
  border-bottom: none;
}

.blog-list article h2 {
  margin: 0 0 0.5rem 0;
  font-size: 1.5rem;
}

.blog-list article h2 a {
  color: var(--text-primary);
  text-decoration: none;
  transition: color 0.2s ease;
}

.blog-list article h2 a:hover {
  color: var(--primary);
}

.blog-list time {
  color: var(--text-secondary);
  font-size: 0.9rem;
}

/* Blogroll sidebar */
.blogroll {
  position: sticky;
  top: 2rem;
  z-index: 10; /* Below header (z-index: 20) */
  height: fit-content;
  background: var(--bg-secondary);
  border: 2px solid var(--bg-tertiary);
  border-radius: 8px;
  padding: 1.5rem;
}

.blogroll h3 {
  margin: 0 0 1.5rem 0;
  font-size: 1.3rem;
  color: var(--primary);
  border-bottom: 2px solid var(--bg-tertiary);
  padding-bottom: 0.5rem;
}

.links-section {
  margin-bottom: 1.5rem;
}

.links-section:last-of-type {
  margin-bottom: 1rem;
}

.links-section h4 {
  font-size: 0.85rem;
  text-transform: uppercase;
  letter-spacing: 0.05em;
  color: var(--text-muted);
  margin: 0 0 0.75rem 0;
  font-weight: 600;
}

.links-section ul {
  list-style: none;
  padding: 0;
  margin: 0;
}

.links-section li {
  margin: 0.5rem 0;
  font-size: 0.9rem;
  line-height: 1.6;
}

.links-section a {
  color: var(--text-primary);
  text-decoration: none;
  transition: color 0.2s ease;
}

.links-section a:hover {
  color: var(--primary);
  text-decoration: underline;
}

.link-meta {
  color: var(--text-muted);
  font-size: 0.8rem;
  margin-left: 0.25rem;
}

/* Blogroll footer */
.blogroll-footer {
  margin-top: 1.5rem;
  padding-top: 1rem;
  border-top: 2px solid var(--bg-tertiary);
}

.retro-note {
  font-size: 0.75rem;
  color: var(--text-muted);
  margin: 0 0 0.75rem 0;
  text-align: center;
  font-style: italic;
}

.rss-badge {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 0.5rem;
  padding: 0.5rem 1rem;
  background: var(--primary);
  color: white;
  text-decoration: none;
  border-radius: 4px;
  font-size: 0.85rem;
  font-weight: 600;
  transition: all 0.2s ease;
}

.rss-badge:hover {
  background: var(--primary-dark);
  transform: translateY(-2px);
  box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
}

.rss-icon {
  font-size: 1.1rem;
}

/* Theme-specific blogroll styles */
.theme-90s .blogroll {
  border: 4px ridge #0000ff;
  box-shadow: 8px 8px 0 rgba(0,0,0,0.4);
  background: rgba(255,255,255,0.95);
}

.theme-brutalist .blogroll {
  border: 3px solid #000000;
  box-shadow: 6px 6px 0 #000000;
  border-radius: 0;
}

.theme-vaporwave .blogroll {
  background: rgba(45, 27, 105, 0.85);
  border: 2px solid #01cdfe;
  box-shadow: 0 0 20px rgba(255, 113, 206, 0.5);
}

.theme-terminal .blogroll {
  background: rgba(0, 20, 0, 0.9);
  border: 2px solid #00ff00;
  box-shadow: 0 0 10px rgba(0, 255, 0, 0.3);
}
</style>
